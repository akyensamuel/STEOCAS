{% extends 'accounting_app/base.html' %}

{% block page_title %}Weekly Summary{% endblock %}
{% block nav_icon %}fas fa-calendar-week{% endblock %}

{% block accounting_content %}
    <!-- Week Header -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                    <i class="fas fa-calendar-week mr-3 text-emerald-600 dark:text-emerald-400"></i>
                    Weekly Summary
                </h2>
                <p class="text-gray-600 dark:text-gray-400">
                    {{ week_start|date:"M d" }} - {{ week_end|date:"M d, Y" }}
                </p>
            </div>
            <div class="text-right">
                {% if previous_week_snapshot %}
                    <div class="flex items-center space-x-4">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Revenue Change</p>
                            <p class="text-lg font-bold {% if revenue_change >= 0 %}text-green-600 dark:text-green-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                                {% if revenue_change >= 0 %}+{% endif %}{{ revenue_change|floatformat:1 }}%
                            </p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Profit Change</p>
                            <p class="text-lg font-bold {% if profit_change >= 0 %}text-green-600 dark:text-green-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                                {% if profit_change >= 0 %}+{% endif %}{{ profit_change|floatformat:1 }}%
                            </p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Weekly Overview Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Revenue -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border-l-4 border-emerald-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Revenue</p>
                    <p class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">₵{{ weekly_snapshot.total_revenue|floatformat:2 }}</p>
                    <div class="flex items-center mt-1">
                        <span class="text-xs text-blue-600 dark:text-blue-400">Regular: ₵{{ weekly_snapshot.regular_revenue|floatformat:2 }}</span>
                        <span class="mx-1 text-gray-400">|</span>
                        <span class="text-xs text-purple-600 dark:text-purple-400">Cash: ₵{{ weekly_snapshot.cash_revenue|floatformat:2 }}</span>
                    </div>
                </div>
                <div class="p-3 bg-emerald-100 dark:bg-emerald-900 rounded-full">
                    <i class="fas fa-dollar-sign text-emerald-600 dark:text-emerald-400 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Net Profit -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border-l-4 {% if weekly_snapshot.net_profit >= 0 %}border-blue-500{% else %}border-red-500{% endif %}">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Net Profit</p>
                    <p class="text-2xl font-bold {% if weekly_snapshot.net_profit >= 0 %}text-blue-600 dark:text-blue-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                        ₵{{ weekly_snapshot.net_profit|floatformat:2 }}
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Margin: {{ weekly_snapshot.profit_margin|floatformat:1 }}%</p>
                </div>
                <div class="p-3 {% if weekly_snapshot.net_profit >= 0 %}bg-blue-100 dark:bg-blue-900{% else %}bg-red-100 dark:bg-red-900{% endif %} rounded-full">
                    <i class="fas fa-chart-line {% if weekly_snapshot.net_profit >= 0 %}text-blue-600 dark:text-blue-400{% else %}text-red-600 dark:text-red-400{% endif %} text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Total Expenses -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border-l-4 border-red-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Expenses</p>
                    <p class="text-2xl font-bold text-red-600 dark:text-red-400">₵{{ weekly_snapshot.total_expenses|floatformat:2 }}</p>
                </div>
                <div class="p-3 bg-red-100 dark:bg-red-900 rounded-full">
                    <i class="fas fa-credit-card text-red-600 dark:text-red-400 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Cash Department Ratio -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border-l-4 border-purple-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Cash Dept. Share</p>
                    <p class="text-2xl font-bold text-purple-600 dark:text-purple-400">{{ weekly_snapshot.cash_department_ratio|floatformat:1 }}%</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">{{ weekly_snapshot.cash_transactions_count }} transactions</p>
                </div>
                <div class="p-3 bg-purple-100 dark:bg-purple-900 rounded-full">
                    <i class="fas fa-money-bill-wave text-purple-600 dark:text-purple-400 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Breakdown -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
            <i class="fas fa-calendar-day mr-2 text-gray-600 dark:text-gray-400"></i>Daily Breakdown
        </h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Day</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Regular Revenue</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Cash Revenue</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Total Revenue</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Expenses</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Net Profit</th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {% for daily in daily_summaries %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ daily.day_name }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ daily.date|date:"M d" }}</p>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 dark:text-blue-400 font-medium">
                            ₵{{ daily.snapshot.regular_revenue|floatformat:2 }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-purple-600 dark:text-purple-400 font-medium">
                            ₵{{ daily.snapshot.cash_revenue|floatformat:2 }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 dark:text-green-400 font-bold">
                            ₵{{ daily.snapshot.total_revenue|floatformat:2 }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 dark:text-red-400 font-medium">
                            ₵{{ daily.snapshot.total_expenses|floatformat:2 }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm {% if daily.snapshot.net_profit >= 0 %}text-blue-600 dark:text-blue-400{% else %}text-red-600 dark:text-red-400{% endif %} font-bold">
                            ₵{{ daily.snapshot.net_profit|floatformat:2 }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Performance Highlights -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Top Products -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                <i class="fas fa-trophy mr-2 text-yellow-500"></i>Top Performing Products
            </h3>
            {% if top_products %}
                <div class="space-y-3">
                    {% for product in top_products %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div>
                            <p class="font-medium text-gray-900 dark:text-white">{{ product.product_name }}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">{{ product.total_quantity_sold }} units sold</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-green-600 dark:text-green-400">₵{{ product.total_revenue|floatformat:2 }}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ product.number_of_sales }} sales</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500 dark:text-gray-400 text-center py-4">No product sales this week</p>
            {% endif %}
        </div>

        <!-- Top Cash Services -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                <i class="fas fa-money-bill-wave mr-2 text-purple-500"></i>Top Cash Services
            </h3>
            {% if top_cash_services %}
                <div class="space-y-3">
                    {% for service in top_cash_services %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div>
                            <p class="font-medium text-gray-900 dark:text-white">{{ service.service_name }}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">₵{{ service.total_amount_processed|floatformat:2 }} processed</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-purple-600 dark:text-purple-400">₵{{ service.total_revenue_generated|floatformat:2 }}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ service.transaction_count }} transactions</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500 dark:text-gray-400 text-center py-4">No cash services this week</p>
            {% endif %}
        </div>
    </div>

    <!-- Staff Performance -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Regular Sales Staff -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                <i class="fas fa-users mr-2 text-blue-500"></i>Regular Sales Staff
            </h3>
            {% if staff_performance %}
                <div class="space-y-3">
                    {% for staff in staff_performance %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div>
                            <p class="font-medium text-gray-900 dark:text-white">{{ staff.user.get_full_name|default:staff.user.username }}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">{{ staff.total_invoices }} invoices</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-blue-600 dark:text-blue-400">₵{{ staff.total_sales_amount|floatformat:2 }}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ staff.conversion_rate|floatformat:1 }}% paid</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500 dark:text-gray-400 text-center py-4">No regular sales this week</p>
            {% endif %}
        </div>

        <!-- Cash Department Staff -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                <i class="fas fa-money-check mr-2 text-purple-500"></i>Cash Department Staff
            </h3>
            {% if cash_staff_performance %}
                <div class="space-y-3">
                    {% for staff in cash_staff_performance %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div>
                            <p class="font-medium text-gray-900 dark:text-white">{{ staff.user.get_full_name|default:staff.user.username }}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">{{ staff.total_transactions }} transactions</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-purple-600 dark:text-purple-400">₵{{ staff.total_cash_amount|floatformat:2 }}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ staff.total_cash_invoices }} invoices</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500 dark:text-gray-400 text-center py-4">No cash department activity this week</p>
            {% endif %}
        </div>
    </div>
{% endblock %}

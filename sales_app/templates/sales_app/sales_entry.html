{% extends "core/base.html" %}
{% load static %}
{% load widget_tweaks %}
{% block content %}
<div class="max-w-5xl mx-auto mt-8 p-6 bg-white dark:bg-gray-800 rounded-lg shadow">
    <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">New Invoice</h2>
    <form method="post" id="sales-form">
        {% csrf_token %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label class="block mb-2 text-sm font-semibold text-gray-900 dark:text-white">Invoice No</label>
                <input type="text" value="{{ invoice_form.instance.invoice_no|default:'(auto)' }}" readonly class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2 cursor-not-allowed" />
            </div>
            <div>
                <label for="id_customer_name" class="block mb-2 text-sm font-semibold text-gray-900 dark:text-white">Customer Name</label>
                {{ invoice_form.customer_name|add_class:'w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2' }}
            </div>
            <div>
                <label for="id_customer_phone" class="block mb-2 text-sm font-semibold text-gray-900 dark:text-white">Customer Phone</label>
                {{ invoice_form.customer_phone|add_class:'w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2' }}
            </div>
            <div>
                <label for="id_date_of_sale" class="block mb-2 text-sm font-semibold text-gray-900 dark:text-white">Date of Sale</label>
                {{ invoice_form.date_of_sale|add_class:'w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2' }}
            </div>
            <div>
                <label class="block mb-2 text-sm font-semibold text-gray-900 dark:text-white">User</label>
                <input type="text" value="{{ request.user.username }}" readonly class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2 cursor-not-allowed" />
            </div>
            <div class="md:col-span-2">
                <label for="id_notes" class="block mb-2 text-sm font-semibold text-gray-900 dark:text-white">Notes/Remarks</label>
                {{ invoice_form.notes|add_class:'w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2' }}
            </div>
        </div>

        <h3 class="text-lg font-semibold mb-2 text-gray-800 dark:text-gray-200">Sale Items</h3>
        
        <!-- Info Notice about Custom Items -->
        <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
            <div class="flex items-start">
                <svg class="w-5 h-5 text-blue-600 dark:text-blue-400 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
                <div class="text-sm text-blue-800 dark:text-blue-200">
                    <span class="font-semibold">Flexible Item Entry:</span> You can search for existing products (auto-fills price and shows stock) <strong>OR</strong> type a custom item name for items not in your product list.
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto mb-6">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase w-96">Item</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Unit Price</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Quantity</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Discount</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Total Price</th>
                        <th class="px-4 py-2"></th>
                    </tr>
                </thead>
                <tbody id="items-table-body">
                    {{ formset.management_form }}
                    {% for form in formset %}
                    <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 form-row">
                        <td class="px-6 py-2">{{ form.item|add_class:'select2-item w-full rounded border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white px-2 py-1' }}</td>
                        <td class="px-4 py-2">{{ form.unit_price|add_class:'w-full rounded border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white px-2 py-1 unit-price' }}</td>
                        <td class="px-4 py-2">{{ form.quantity|add_class:'w-full rounded border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white px-2 py-1 quantity' }}</td>
                        <td class="px-4 py-2">{{ form.discount|add_class:'w-full rounded border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white px-2 py-1 discount' }}</td>
                        <td class="px-4 py-2">{{ form.total_price|add_class:'w-full rounded border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white px-2 py-1 total-price' }}</td>
                        <td class="px-4 py-2 text-center">
                            <button type="button" class="add-row text-green-600 hover:text-green-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg></button>
                            <button type="button" class="remove-row text-red-600 hover:text-red-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg></button>
                        </td>
                    </tr>
                    {% endfor %}
                    <!-- Hidden template row for JS cloning:this uses Django formset's empty_form ;) -->
                    <tr id="template-row" class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 form-row" style="display:none;">
                        <td class="px-6 py-2">{{ formset.empty_form.item|add_class:'select2-item w-full rounded border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white px-2 py-1' }}</td>
                        <td class="px-4 py-2">{{ formset.empty_form.unit_price|add_class:'w-full rounded border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white px-2 py-1 unit-price' }}</td>
                        <td class="px-4 py-2">{{ formset.empty_form.quantity|add_class:'w-full rounded border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white px-2 py-1 quantity' }}</td>
                        <td class="px-4 py-2">{{ formset.empty_form.discount|add_class:'w-full rounded border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white px-2 py-1 discount' }}</td>
                        <td class="px-4 py-2">{{ formset.empty_form.total_price|add_class:'w-full rounded border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white px-2 py-1 total-price' }}</td>
                        <td class="px-4 py-2 text-center">
                            <button type="button" class="add-row text-green-600 hover:text-green-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg></button>
                            <button type="button" class="remove-row text-red-600 hover:text-red-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg></button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
            <div class="text-lg font-semibold text-gray-900 dark:text-gray-100">TOTAL: <span id="grand-total">0.00</span></div>
            <div class="w-full md:w-1/3">
                <label for="id_amount_paid" class="block mb-2 text-sm font-semibold text-gray-900 dark:text-white">Amount Paid</label>
                {{ invoice_form.amount_paid|add_class:'w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2' }}
            </div>
            <div class="w-full md:w-1/3">
                <label class="block mb-2 text-sm font-semibold text-gray-900 dark:text-white">Balance</label>
                <input type="text" id="balance-field" readonly class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2 cursor-not-allowed" value="0.00" />
            </div>
        </div>
        <div class="flex flex-col sm:flex-row gap-4">
            <button type="submit" name="save_print" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Save and Print</button>
            <button type="submit" name="save" class="text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800">Save</button>
        </div>
    </form>
</div>

<!-- Load jQuery and Select2 before custom JS -->
<script src="{% static 'sales_app/js/jquery.min.js' %}"></script>
<link href="{% static 'sales_app/css/select2.min.css' %}" rel="stylesheet" />
<script src="{% static 'sales_app/js/select2.min.js' %}"></script>

<!-- Custom Select2 Styling for Dark Mode and Tailwind Integration -->
<style>
/* Light Mode Select2 Styling */
.select2-container .select2-selection--single {
    height: 34px !important;
    border: 1px solid #d1d5db !important;
    border-radius: 0.375rem !important;
    background-color: #f9fafb !important;
    padding: 0 8px !important;
    display: flex !important;
    align-items: center !important;
}

.select2-container .select2-selection--single .select2-selection__rendered {
    color: #111827 !important;
    padding: 0 !important;
    line-height: 32px !important;
}

.select2-container .select2-selection--single .select2-selection__arrow {
    height: 32px !important;
    right: 8px !important;
}

.select2-dropdown {
    border: 1px solid #d1d5db !important;
    border-radius: 0.375rem !important;
    background-color: #ffffff !important;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
}

.select2-container--default .select2-results__option {
    padding: 8px 12px !important;
    color: #111827 !important;
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #3b82f6 !important;
    color: white !important;
}

.select2-container--default .select2-search--dropdown .select2-search__field {
    border: 1px solid #d1d5db !important;
    border-radius: 0.375rem !important;
    padding: 8px 12px !important;
    color: #111827 !important;
    background-color: #f9fafb !important;
}

/* Dark Mode Select2 Styling */
@media (prefers-color-scheme: dark) {
    .select2-container .select2-selection--single {
        border-color: #4b5563 !important;
        background-color: #374151 !important;
    }

    .select2-container .select2-selection--single .select2-selection__rendered {
        color: #ffffff !important;
    }

    .select2-dropdown {
        border-color: #4b5563 !important;
        background-color: #1f2937 !important;
    }

    .select2-container--default .select2-results__option {
        color: #ffffff !important;
    }

    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: #3b82f6 !important;
    }

    .select2-container--default .select2-search--dropdown .select2-search__field {
        border-color: #4b5563 !important;
        background-color: #374151 !important;
        color: #ffffff !important;
    }
}

/* Dark class-based styling (for manual dark mode toggle) */
.dark .select2-container .select2-selection--single {
    border-color: #4b5563 !important;
    background-color: #374151 !important;
}

.dark .select2-container .select2-selection--single .select2-selection__rendered {
    color: #ffffff !important;
}

.dark .select2-dropdown {
    border-color: #4b5563 !important;
    background-color: #1f2937 !important;
}

.dark .select2-container--default .select2-results__option {
    color: #ffffff !important;
}

.dark .select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #3b82f6 !important;
}

.dark .select2-container--default .select2-search--dropdown .select2-search__field {
    border-color: #4b5563 !important;
    background-color: #374151 !important;
    color: #ffffff !important;
}

/* Focus states */
.select2-container--default.select2-container--focus .select2-selection--single {
    border-color: #3b82f6 !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
}

.dark .select2-container--default.select2-container--focus .select2-selection--single {
    border-color: #3b82f6 !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
}

/* Placeholder styling */
.select2-container--default .select2-selection--single .select2-selection__placeholder {
    color: #6b7280 !important;
}

.dark .select2-container--default .select2-selection--single .select2-selection__placeholder {
    color: #9ca3af !important;
}

/* Clear button styling */
.select2-container--default .select2-selection--single .select2-selection__clear {
    color: #6b7280 !important;
    font-size: 18px !important;
    margin-right: 8px !important;
}

.dark .select2-container--default .select2-selection--single .select2-selection__clear {
    color: #9ca3af !important;
}

.select2-container--default .select2-selection--single .select2-selection__clear:hover {
    color: #374151 !important;
}

.dark .select2-container--default .select2-selection--single .select2-selection__clear:hover {
    color: #d1d5db !important;
}
</style>

<script>
$(document).ready(function() {
    const STORAGE_KEY = 'sales_entry_form_data_v1';
    
    function updateRowTotal(row) {
        const unitPrice = row.querySelector('.unit-price');
        const quantity = row.querySelector('.quantity');
        const discount = row.querySelector('.discount');
        const totalPrice = row.querySelector('.total-price');
        if (unitPrice && quantity && totalPrice) {
            const up = parseFloat(unitPrice.value) || 0;
            const qty = parseFloat(quantity.value) || 0;
            const disc = parseFloat(discount ? discount.value : 0) || 0;
            totalPrice.value = ((up * qty) - disc).toFixed(2);
        }
    }
    
    function updateTotals() {
        // Update all row totals first
        document.querySelectorAll('#items-table-body tr').forEach(function(row) {
            updateRowTotal(row);
        });
        // Then sum for grand total
        let grandTotal = 0;
        document.querySelectorAll('.total-price').forEach(function(input) {
            let val = parseFloat(input.value) || 0;
            grandTotal += val;
        });
        document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
        // Update balance field
        const amountPaidInput = document.getElementById('id_amount_paid');
        const balanceField = document.getElementById('balance-field');
        if (amountPaidInput && balanceField) {
            const paid = parseFloat(amountPaidInput.value) || 0;
            balanceField.value = (grandTotal - paid).toFixed(2);
        }
    }
    
    function validateQuantityAgainstStock(row) {
        const quantityInput = row.querySelector('.quantity');
        const itemSelect = row.querySelector('select[name*="item"]');
        
        if (!quantityInput || !itemSelect) return true;
        
        const quantity = parseInt(quantityInput.value) || 0;
        const selectedOption = $(itemSelect).select2('data')[0];
        
        if (selectedOption && selectedOption.stock !== undefined && selectedOption.isExisting) {
            const availableStock = parseInt(selectedOption.stock) || 0;
            
            if (quantity > availableStock) {
                // Show informational notice (not a blocker)
                quantityInput.style.borderColor = '#f59e0b'; // Orange border
                quantityInput.style.backgroundColor = '#fffbeb'; // Light yellow bg
                
                const existingWarning = row.querySelector('.stock-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }
                
                const shortage = quantity - availableStock;
                const infoDiv = document.createElement('div');
                infoDiv.className = 'stock-warning text-orange-600 dark:text-orange-400 text-xs mt-1';
                infoDiv.innerHTML = `<i class="fas fa-info-circle"></i> ${availableStock} in stock, ${shortage} will be backorder`;
                quantityInput.parentNode.appendChild(infoDiv);
                
                return true; // Allow the sale to proceed
            } else {
                // Remove informational styling
                quantityInput.style.borderColor = '';
                quantityInput.style.backgroundColor = '';
                
                const existingWarning = row.querySelector('.stock-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }
                
                return true;
            }
        }
        
        return true;
    }
    
    function bindRowInputs(row) {
        // Bind input event listeners
        row.querySelectorAll('.unit-price, .quantity, .discount').forEach(function(input) {
            input.addEventListener('input', function() {
                if (input.classList.contains('quantity')) {
                    validateQuantityAgainstStock(row);
                }
                updateRowTotal(row);
                updateTotals();
                saveFormToStorage();
            });
        });
        
        // Handle item input (now supporting both text input and select)
        const itemInput = row.querySelector('input[name*="item"], select[name*="item"]');
        if (itemInput) {
            itemInput.addEventListener('change', function() {
                // Clear any existing stock warnings when item changes
                const existingWarning = row.querySelector('.stock-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }
                
                updateRowTotal(row);
                updateTotals();
                saveFormToStorage();
            });

            // Initialize Select2 with tagging support (allows custom entries)
            $(itemInput).select2({
                ajax: {
                    url: '/sales/api/products/',
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return { q: params.term };
                    },
                    processResults: function(data) {
                        return {
                            results: data.map(function(item) {
                                return { 
                                    id: item.name, // Use name as ID for text-based field
                                    text: item.name + ' (Stock: ' + (item.stock || 0) + ', Price: â‚µ' + item.unit_price + ')',
                                    unit_price: item.unit_price,
                                    stock: item.stock || 0,
                                    isExisting: true
                                };
                            })
                        };
                    },
                    cache: true
                },
                tags: true, // Enable tagging to allow custom entries
                createTag: function(params) {
                    var term = $.trim(params.term);
                    if (term === '') {
                        return null;
                    }
                    return {
                        id: term,
                        text: term + ' (Custom item)',
                        isExisting: false,
                        unit_price: null,
                        stock: 0
                    };
                },
                insertTag: function(data, tag) {
                    // Insert the custom tag at the beginning of the results
                    data.unshift(tag);
                },
                minimumInputLength: 0, // Allow showing results immediately
                placeholder: 'Search or type custom item...',
                allowClear: true,
                width: '100%',
                dropdownParent: $(itemInput).closest('td'),
                theme: 'default',
                // Allow selecting by pressing Enter
                selectOnClose: false
            });

            // Handle Select2 selection
            $(itemInput).on('select2:select', function(e) {
                var data = e.params.data;
                console.log("DEBUG: select2:select event fired");
                console.log("DEBUG: Selected item:", data.id, "| Text:", data.text, "| isExisting:", data.isExisting);

                // Ensure the value is set on the select element
                if (!$(itemInput).find('option[value="' + data.id + '"]').length) {
                    // Create the option if it doesn't exist (for custom/tagged items)
                    var newOption = new Option(data.id, data.id, true, true);
                    $(itemInput).append(newOption);
                }
                $(itemInput).val(data.id).trigger('change');
                
                var rowElement = itemInput.closest('tr');
                if (!rowElement) {
                    console.error("DEBUG: Could not find parent row for itemInput");
                    return;
                }

                var unitPriceInput = rowElement.querySelector('.unit-price');

                // Only auto-fill price if it's an existing product
                if (data.isExisting && unitPriceInput && data.unit_price !== undefined && data.unit_price !== null) {
                    console.log("DEBUG: Existing product - auto-filling price:", data.unit_price);

                    var priceToSet = data.unit_price;
                    unitPriceInput.value = priceToSet;

                    var inputEvent = new Event('input', { bubbles: true, cancelable: true });
                    var changeEvent = new Event('change', { bubbles: true, cancelable: true });
                    unitPriceInput.dispatchEvent(inputEvent);
                    unitPriceInput.dispatchEvent(changeEvent);

                    updateRowTotal(rowElement);
                    updateTotals();
                    
                    // Validate quantity against stock for existing products
                    setTimeout(function() {
                        validateQuantityAgainstStock(rowElement);
                    }, 100);
                } else if (!data.isExisting) {
                    console.log("DEBUG: Custom item - user must enter price manually");
                    // For custom items, clear price and focus on the unit price field
                    if (unitPriceInput) {
                        unitPriceInput.value = '';
                        unitPriceInput.focus();
                        
                        // Show a helpful message
                        var existingHint = rowElement.querySelector('.custom-item-hint');
                        if (existingHint) {
                            existingHint.remove();
                        }
                        
                        var hintDiv = document.createElement('div');
                        hintDiv.className = 'custom-item-hint text-blue-600 dark:text-blue-400 text-xs mt-1';
                        hintDiv.textContent = 'Custom item - please enter price';
                        unitPriceInput.parentNode.appendChild(hintDiv);
                        
                        // Remove hint after 3 seconds
                        setTimeout(function() {
                            if (hintDiv.parentNode) {
                                hintDiv.remove();
                            }
                        }, 3000);
                    }
                }
                
                saveFormToStorage();
            });
        }
    }

    function saveFormToStorage() {
        const rows = [];
        document.querySelectorAll('#items-table-body tr').forEach(function(row) {
            const itemInput = row.querySelector('input[name*="item"], select[name*="item"]');
            const item = itemInput?.value || '';
            const unitPrice = row.querySelector('.unit-price')?.value || '';
            const quantity = row.querySelector('.quantity')?.value || '';
            const discount = row.querySelector('.discount')?.value || '';
            const totalPrice = row.querySelector('.total-price')?.value || '';
            rows.push({ item, unitPrice, quantity, discount, totalPrice });
        });
        const invoiceFields = {
            customer_name: document.getElementById('id_customer_name')?.value || '',
            date_of_sale: document.getElementById('id_date_of_sale')?.value || '',
            notes: document.getElementById('id_notes')?.value || '',
            amount_paid: document.getElementById('id_amount_paid')?.value || ''
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ rows, invoiceFields }));
    }

    function restoreFormFromStorage() {
        const data = localStorage.getItem(STORAGE_KEY);
        if (!data) return;
        try {
            const parsed = JSON.parse(data);
            if (parsed.invoiceFields) {
                // Restore invoice fields
                if (parsed.invoiceFields.customer_name) {
                    const customerNameField = document.getElementById('id_customer_name');
                    if (customerNameField) customerNameField.value = parsed.invoiceFields.customer_name;
                }
                if (parsed.invoiceFields.date_of_sale) {
                    const dateField = document.getElementById('id_date_of_sale');
                    if (dateField) dateField.value = parsed.invoiceFields.date_of_sale;
                }
                if (parsed.invoiceFields.notes) {
                    const notesField = document.getElementById('id_notes');
                    if (notesField) notesField.value = parsed.invoiceFields.notes;
                }
                if (parsed.invoiceFields.amount_paid) {
                    const amountPaidField = document.getElementById('id_amount_paid');
                    if (amountPaidField) amountPaidField.value = parsed.invoiceFields.amount_paid;
                }
            }
            
            if (Array.isArray(parsed.rows) && parsed.rows.length > 0) {
                const tableBody = document.getElementById('items-table-body');
                let totalForms = document.getElementById('id_form-TOTAL_FORMS') ||
                                document.querySelector('input[name*="TOTAL_FORMS"]') ||
                                document.querySelector('input[name$="-TOTAL_FORMS"]');

                const templateRow = document.getElementById('template-row');
                const templateRowExists = templateRow !== null;

                // Remove existing data rows, but keep the first one (form-0) and the template row
                for (let i = tableBody.children.length - 1; i >= 0; i--) {
                    const child = tableBody.children[i];
                    if (i === 0 || (templateRowExists && child === templateRow)) {
                        continue;
                    }
                    tableBody.removeChild(child);
                }

                // Populate the first existing row (form-0) with data from parsed.rows[0]
                if (tableBody.children.length > 0) {
                    const firstRow = tableBody.children[0];
                    const first = parsed.rows[0];
                    if (firstRow && first) {
                        const itemElement = firstRow.querySelector('select[name*="item"]') || firstRow.querySelector('input[name*="item"]');
                        if (itemElement) itemElement.value = first.item;
                        const unitPriceInput = firstRow.querySelector('.unit-price');
                        if (unitPriceInput) unitPriceInput.value = first.unitPrice;
                        const quantityInput = firstRow.querySelector('.quantity');
                        if (quantityInput) quantityInput.value = first.quantity;
                        const discountInput = firstRow.querySelector('.discount');
                        if (discountInput) discountInput.value = first.discount;
                        const totalPriceInput = firstRow.querySelector('.total-price');
                        if (totalPriceInput) totalPriceInput.value = first.totalPrice;
                    }
                }

                // For each additional row needed, add a new one and populate it
                for (let i = 1; i < parsed.rows.length; i++) {
                    addNewRow();
                    const rows = tableBody.querySelectorAll('.form-row');
                    const newRow = rows[rows.length - 1];
                    const rowData = parsed.rows[i];

                    if (newRow && rowData) {
                        const itemElement = newRow.querySelector('select[name*="item"]') || newRow.querySelector('input[name*="item"]');
                        if (itemElement) itemElement.value = rowData.item;
                        const unitPriceInput = newRow.querySelector('.unit-price');
                        if (unitPriceInput) unitPriceInput.value = rowData.unitPrice;
                        const quantityInput = newRow.querySelector('.quantity');
                        if (quantityInput) quantityInput.value = rowData.quantity;
                        const discountInput = newRow.querySelector('.discount');
                        if (discountInput) discountInput.value = rowData.discount;
                        const totalPriceInput = newRow.querySelector('.total-price');
                        if (totalPriceInput) totalPriceInput.value = rowData.totalPrice;
                    }
                }

                // Update the management form TOTAL_FORMS count
                if (totalForms) {
                    totalForms.value = parsed.rows.length.toString();
                }
                
                // Re-bind event listeners to all rows
                document.querySelectorAll('#items-table-body tr').forEach(function(row) {
                    if (row.id !== 'template-row') {
                        bindRowInputs(row);
                    }
                });
            }
        } catch (e) {
            console.error('Error restoring form data:', e);
        }
    }

    function addNewRow() {
        const tableBody = document.getElementById('items-table-body');
        let totalForms = document.getElementById('id_form-TOTAL_FORMS');
        if (!totalForms) {
            totalForms = document.querySelector('input[name*="TOTAL_FORMS"]');
        }
        if (!totalForms) {
            totalForms = document.querySelector('input[name$="-TOTAL_FORMS"]');
        }
        let currentCount = totalForms ? parseInt(totalForms.value) : tableBody.querySelectorAll('.form-row').length;
        const templateRow = document.getElementById('template-row');
        const newRow = templateRow.cloneNode(true);
        newRow.style.display = '';
        newRow.id = '';
        newRow.querySelectorAll('input, select, textarea, label').forEach(function(el) {
            if (el.name) {
                el.name = el.name.replace(/__prefix__/, currentCount);
            }
            if (el.id) {
                el.id = el.id.replace(/__prefix__/, currentCount);
            }
            if (el.htmlFor) {
                el.htmlFor = el.htmlFor.replace(/__prefix__/, currentCount);
            }
            if (typeof el.value !== 'undefined' && el.type !== 'hidden') {
                el.value = '';
            }
        });
        tableBody.appendChild(newRow);
        if (totalForms) {
            totalForms.value = (currentCount + 1).toString();
        }
        bindRowInputs(newRow);
        updateTotals();
    }

    // Function to check stock levels before form submission (informational only, non-blocking)
    function validateAllQuantities() {
        const backorders = [];
        
        try {
            const rows = document.querySelectorAll('#items-table-body tr');
            console.log(`Checking stock for ${rows.length} rows`);
            
            rows.forEach(function(row) {
                if (row.id === 'template-row') return;
                
                const quantityInput = row.querySelector('.quantity');
                const itemSelect = row.querySelector('select[name*="item"]');
                
                if (!quantityInput || !itemSelect) {
                    console.warn('Missing quantity or item input in row');
                    return;
                }
                
                const quantity = parseInt(quantityInput.value) || 0;
                if (quantity <= 0) return; // Skip empty rows
                
                // Get Select2 data safely
                let selectedOption = null;
                try {
                    const select2Data = $(itemSelect).select2('data');
                    selectedOption = select2Data && select2Data[0];
                } catch (select2Error) {
                    console.warn('Select2 error:', select2Error);
                    // Fallback to standard select option
                    const selectedIndex = itemSelect.selectedIndex;
                    if (selectedIndex >= 0) {
                        selectedOption = {
                            text: itemSelect.options[selectedIndex].text,
                            stock: parseInt(itemSelect.options[selectedIndex].dataset.stock) || 0,
                            isExisting: true
                        };
                    }
                }
                
                // Only check stock for existing products (not custom items)
                if (selectedOption && selectedOption.isExisting && selectedOption.stock !== undefined && quantity > 0) {
                    const availableStock = parseInt(selectedOption.stock) || 0;
                    const itemName = selectedOption.text ? selectedOption.text.split(' (Stock:')[0] : 'Unknown Item';
                    
                    if (quantity > availableStock) {
                        const shortage = quantity - availableStock;
                        backorders.push(`${itemName}: ${shortage} units will be backorder (${availableStock} available)`);
                        console.info(`BACKORDER: ${itemName} - ${shortage} units`);
                    }
                }
            });
            
        } catch (error) {
            console.error('Stock check error:', error);
            // Don't block submission on errors
        }
        
        // Log backorder info but don't block the sale
        if (backorders.length > 0) {
            console.info('Backorders detected:', backorders);
            // Optional: Show non-blocking notification
            // You can uncomment this if you want to inform users:
            // console.log('Note: Some items will be on backorder');
        }
        
        console.log('Stock check complete - sale proceeding');
        return true; // Always return true (never block sales)
    }

    // Event listeners
    const amountPaidInput = document.getElementById('id_amount_paid');
    if (amountPaidInput) {
        amountPaidInput.addEventListener('input', function() {
            updateTotals();
            saveFormToStorage();
        });
    }
    
    ['id_customer_name', 'id_date_of_sale', 'id_notes'].forEach(function(id) {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', saveFormToStorage);
            el.addEventListener('change', saveFormToStorage);
        }
    });
    
    // Bind all initial rows
    document.querySelectorAll('#items-table-body tr').forEach(function(row) {
        if (row.id !== 'template-row') {
            bindRowInputs(row);
        }
    });
    
    // Restore from localStorage if present
    restoreFormFromStorage();
    updateTotals();
    
    // Add row logic (event delegation for all add-row buttons)
    document.getElementById('items-table-body').addEventListener('click', function(e) {
        if (e.target.closest('.add-row')) {
            saveFormToStorage();
            addNewRow();
            var rows = document.querySelectorAll('#items-table-body tr');
            var lastRow = rows[rows.length - 1];
            bindRowInputs(lastRow);
            saveFormToStorage();
        }
    });
    
    // Remove row logic
    document.getElementById('items-table-body').addEventListener('click', function(e) {
        if (e.target.closest('.remove-row')) {
            const row = e.target.closest('tr');
            const tableBody = document.getElementById('items-table-body');
            if (tableBody.children.length > 1) {
                row.remove();
                let totalForms = document.getElementById('id_form-TOTAL_FORMS');
                if (!totalForms) {
                    totalForms = document.querySelector('input[name*="TOTAL_FORMS"]');
                }
                if (!totalForms) {
                    totalForms = document.querySelector('input[name$="-TOTAL_FORMS"]');
                }
                if (totalForms) {
                    totalForms.value = (tableBody.children.length).toString();
                }
                updateTotals();
                saveFormToStorage();
            }
        }
    });
    
    // Form submission with validation and error handling
    document.getElementById('sales-form').addEventListener('submit', function(e) {
        console.log('Form submission started...');
        
        try {
            // Validate quantities before allowing submission
            if (!validateAllQuantities()) {
                console.error('Stock validation failed');
                e.preventDefault();
                return false;
            }
            
            // Robust formset management
            const tableBody = document.getElementById('items-table-body');
            if (!tableBody) {
                console.error('Table body not found');
                alert('Form error: Unable to find items table. Please refresh and try again.');
                e.preventDefault();
                return false;
            }
            
            const rows = Array.from(tableBody.querySelectorAll('tr')).filter(row => row.id !== 'template-row');
            console.log(`Found ${rows.length} rows to submit`);
            
            // Multiple approaches to find TOTAL_FORMS field
            let totalForms = document.getElementById('id_form-TOTAL_FORMS') ||
                           document.querySelector('input[name$="form-TOTAL_FORMS"]') ||
                           document.querySelector('input[name*="TOTAL_FORMS"]') ||
                           document.querySelector('input[name$="-TOTAL_FORMS"]');
            
            if (!totalForms) {
                console.error('TOTAL_FORMS field not found');
                alert('Form error: Unable to submit. Please refresh the page and try again.');
                e.preventDefault();
                return false;
            }
            
            totalForms.value = rows.length.toString();
            console.log(`Set TOTAL_FORMS to ${totalForms.value}`);
            
            // Validate that we have at least one item
            const hasValidItems = rows.some(row => {
                const itemSelect = row.querySelector('select[name*="item"]');
                const quantityInput = row.querySelector('.quantity');
                return itemSelect && itemSelect.value && quantityInput && parseFloat(quantityInput.value) > 0;
            });
            
            if (!hasValidItems) {
                console.error('No valid items found');
                alert('Please add at least one item with valid quantity before saving.');
                e.preventDefault();
                return false;
            }
            
            // Clear localStorage on successful validation
            try {
                localStorage.removeItem(STORAGE_KEY);
                console.log('localStorage cleared');
            } catch (storageError) {
                console.warn('Failed to clear localStorage:', storageError);
                // Don't prevent form submission for localStorage errors
            }
            
            // Add loading state to prevent double submissions
            const submitButton = e.submitter || document.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = submitButton.name === 'save_print' ? 'Saving & Printing...' : 'Saving...';
                
                // Re-enable after timeout as fallback
                setTimeout(() => {
                    submitButton.disabled = false;
                    submitButton.textContent = submitButton.name === 'save_print' ? 'Save and Print' : 'Save';
                }, 5000);
            }
            
            console.log('Form validation passed, submitting...');
            
        } catch (error) {
            console.error('Form submission error:', error);
            alert('An error occurred while preparing the form. Please try again.');
            e.preventDefault();
            return false;
        }
        
        // Allow the form to submit normally - Django will handle the response
    });
});
</script>
{% endblock %}